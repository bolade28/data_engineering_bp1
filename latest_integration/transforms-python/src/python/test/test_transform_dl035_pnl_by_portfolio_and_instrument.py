from datetime import date
from pandas.testing import assert_frame_equal
from python.pnl.transformed.dl035_pnl_by_portfolio_and_instrument import dtd_calc
from python.pnl.schema.schema_dl035_pnl_by_portfolio_and_instrument import typed_output_schema
from python.pnl.schema.schema_dl035_pnl_by_portfolio_and_instrument import transformed_output_schema


def test_transform_dnl101_pnl_detail(spark_session):

    input_data = [(None, date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "CASH", 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                   0.0, 0.0, 0.0, -0.03, -0.03, 0.0, -0.03, -0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, None),

                  (None, date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "GAS-SUPPLY", -1720701.04162955, -1334169.72802819,
                   -386531.31360135, -1722043.56602481, -1335210.63310554, -386832.93291927, -1.071453195856529E7,
                   -9471571.19844753, -1242960.76011776, -1.072288243961251E7, -9478951.94305623, -1243930.49655629,
                   -8.857197112614144E7, -8.944111249282816E7, 869141.36668673, -8.857945442546684E7,
                   -8.945077899669771E7, 871324.5712309, -5.0667956491263723E8, -5.051220176028133E8, 1557547.30982399,
                   -5.066892314165069E8, -5.051295009021386E8, 1559730.51436816, None),

                  (None, date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "COMM-FEE", 287076.41789416, 76695.7406345,
                   210380.67725966, 284137.42828637, 76005.41970038, 208132.00858599, 463347.96666067, -634083.68252305,
                   1097431.64918371, 460408.97705288, -634774.00345716, 1095182.98051004, -6404933.87053552,
                   -5431315.36887564, -973618.50165992, -6407872.86014331, -5432005.68980976, -975867.1703336,
                   -2.644613124562252E7, -2.808755282323321E7, -1641421.5776107, -2.644682156655663E7,
                   -2.8090491812841E7, -1643670.24628437, None),
                  ]

    expected_data = [(date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "CASH", 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                      0.0, 0.0, 0.0, -0.03, -0.03, 0.0, -0.03, -0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, None, None),

                     (date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "GAS-SUPPLY", -1720701.04162955, -1334169.72802819,
                      -386531.31360135, -1722043.56602481, -1335210.63310554, -386832.93291927, -10714531.95856529,
                      -9471571.19844753, -1242960.76011776, -10722882.43961251, -9478951.94305623, -1243930.49655629,
                      -88571971.12614144, -89441112.49282816, 869141.36668673, -88579454.42546684, -89450778.99669771,
                      871324.5712309, -506679564.91263723, -505122017.6028133, 1557547.30982399, -506689231.4165069,
                      -505129500.9021386, 1559730.51436816, None, None),

                     (date(2019, 10, 21), "GTE_UK_BPGM", "GBP", "COMM-FEE", 287076.41789416, 76695.7406345,
                      210380.67725966, 284137.42828637, 76005.41970038, 208132.00858599, 463347.96666067,
                      -634083.68252305, 1097431.64918371, 460408.97705288, -634774.00345716, 1095182.98051004,
                      -6404933.87053552, -5431315.36887564, -973618.50165992, -6407872.86014331, -5432005.68980976,
                      -975867.1703336, -26446131.24562252, -28087552.82323321, -1641421.5776107, -26446821.56655663,
                      -28090491.812841, -1643670.24628437, None, None),
                     ]

    df = spark_session.createDataFrame(data=input_data, schema=typed_output_schema)
    df_actual = dtd_calc(df)

    df_expected = spark_session.createDataFrame(data=expected_data, schema=transformed_output_schema)

    # Test that the two schemas are the same
    assert(df_actual.schema == df_expected.schema)

    # Test that the content of the two dataframes are equal
    assert_frame_equal(df_actual.toPandas(), df_expected.toPandas())
